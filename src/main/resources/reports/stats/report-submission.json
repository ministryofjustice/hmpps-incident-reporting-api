{
  "id": "report-submission",
  "name": "Incident report submission statistics",
  "description": "Statistics focusing on time taken for reporting officers to submit reports.",
  "metadata": {
    "author": "Josh Jones",
    "version": "1.0.0",
    "owner": "Managing Safety"
  },
  "datasource": [
    {
      "id": "irs",
      "name": "replicaDataSource",
      "connection": "postgres"
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "INCIDENT_REPORTS__STATS"
              ]
            }
          ]
        }
      ]
    }
  ],
  "dataset": [
    {
      "id": "per-month",
      "name": "Submission statistics per month",
      "datasource": "replicaDataSource",
      "query": "select Cast(Date_trunc('month', reported_at) AS DATE) as month, to_char(min(reported_at), 'DD/MM/YYYY') as min_date, to_char(max(reported_at), 'DD/MM/YYYY') as max_date, \n\tCOALESCE(location, 'all active locations') as location, count(id) as total_reports, \n\tROUND(AVG(time_diff_mins),1) as avg_mins, \n\tROUND(CAST(PERCENTILE_CONT(0.5) WITHIN GROUP(ORDER BY time_diff_mins) as numeric),1) as median_mins, \n\tROUND(MAX(time_diff_hrs),1) as longest_submitted_hrs, \n\tcount(CASE WHEN (time_diff_hrs > 72) THEN id END) as number_took_too_long,\n\tROUND((CAST(count(CASE WHEN (time_diff_hrs > 72) THEN id END) as numeric)/CAST(count(id) as numeric))*100, 1) as perc_too_long,\n\tROUND(AVG(CASE WHEN time_diff_mins < 4320 THEN time_diff_mins END),1) as avg_mins_wo_too_long, \n\tcount(CASE WHEN correction_requested_at is null THEN id END) as not_yet_actioned,\n\tcount(CASE WHEN status = 'DRAFT' THEN id END) as currently_in_draft,\n\tcount(CASE WHEN status = 'DRAFT' and ROUND(EXTRACT(epoch from (CURRENT_TIMESTAMP - reported_at))/3600, 1) > 72 THEN id END) as number_overdue\nfrom (\n\tselect *, time_diff_mins/60 as time_diff_hrs\n\tfrom (\n\t\tselect r.id, r.location, r.type, r.status, r.reported_at, cr.correction_requested_at, cr.user_action, \n\t\t\tCASE when (correction_requested_at is not null) then ROUND(EXTRACT(epoch from (cr.correction_requested_at - r.reported_at))/60, 1)\n\t\t\telse null end as time_diff_mins\n\t\tfrom report as r\n\t\tleft join (\n\t\t\tselect report_id, correction_requested_at, user_action \n\t\t\tfrom correction_request\n\t\t\twhere sequence = 0 and user_action in ('REQUEST_REVIEW', 'REQUEST_NOT_REPORTABLE', 'REQUEST_DUPLICATE') and user_type = 'REPORTING_OFFICER'\n\t\t\t) as cr\n\t\t\ton r.id = cr.report_id\n\t\twhere location not in ('NORTH', 'SOUTH') and source = 'DPS'\n\t)\n)\ngroup by Date_trunc('month', reported_at), ROLLUP(location)",
      "schema": {
        "field": [
          {
            "name": "month",
            "type": "date"
          },
          {
            "name": "min_date",
            "type": "date"
          },
          {
            "name": "max_date",
            "type": "date"
          },
          {
            "name": "location",
            "type": "string"
          },
          {
            "name": "total_reports",
            "type": "long"
          },
          {
            "name": "avg_mins",
            "type": "float"
          },
          {
            "name": "median_mins",
            "type": "float"
          },
          {
            "name": "longest_submitted_hrs",
            "type": "float"
          },
          {
            "name": "number_took_too_long",
            "type": "long"
          },
          {
            "name": "perc_too_long",
            "type": "float"
          },
          {
            "name": "avg_mins_wo_too_long",
            "type": "float"
          },
          {
            "name": "not_yet_actioned",
            "type": "long"
          },
          {
            "name": "currently_in_draft",
            "type": "long"
          },
          {
            "name": "number_overdue",
            "type": "long"
          }
        ]
      }
    }
  ],
  "report": [
    {
      "id": "per-month",
      "name": "RO submission statistics / month",
      "description": "Statistics focusing on time taken for reporting officers to submit reports per month.",
      "version": "1.0.0",
      "dataset": "$ref:per-month",
      "policy": [],
      "render": "HTML",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:month",
            "display": "Month <br/>of incident",
            "formula": "format_date(${month}, 'MMM-yyyy')",
            "sortable": true,
            "visible": "true",
            "defaultsort": true,
            "sortdirection": "desc",
            "filter": {
              "type": "daterange",
              "default": "today(-3,months) - today()"
            }
          },
          {
            "name": "$ref:location",
            "display": "Location",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:total_reports",
            "display": "All reports <br/>created",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:avg_mins",
            "display": "Average time <br/>to submit (mins)",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:median_mins",
            "display": "Median time to <br/>submit (mins)",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:longest_submitted_hrs",
            "display": "Longest time to <br/>submit report (hrs)",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:number_took_too_long",
            "display": "Number of reports <br/>submitted after 72 hrs",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:perc_too_long",
            "formula": "${perc_too_long}%",
            "display": "Percentage of <br/>reports submitted after 72 hrs",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:avg_mins_wo_too_long",
            "display": "Average time to submit <br/>within 72 hrs (mins)",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:not_yet_actioned",
            "display": "Reports not yet <br/> actioned",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:currently_in_draft",
            "display": "Reports currently <br/>in draft",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:number_overdue",
            "display": "Reports currently <br/>overdue",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          }
        ]
      },
      "destination": []
    }
  ]
}
