{
  "id": "dw-activity",
  "name": "Data warden report activities",
  "description": "Count of incident report actions conducted by each data warden for a given period.",
  "metadata": {
    "author": "Josh Jones",
    "version": "1.0.0",
    "owner": "Managing Safety"
  },
  "datasource": [
    {
      "id": "irs",
      "name": "replicaDataSource",
      "connection": "postgres"
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "INCIDENT_REPORTS__STATS"
              ]
            }
          ]
        }
      ]
    }
  ],
  "dataset": [
    {
      "id": "per-day",
      "name": "Actions performed / day",
      "datasource": "replicaDataSource",
      "query": "select Cast(Date_trunc('day', correction_requested_at) AS DATE)         as day,\n       to_char(min(correction_requested_at), 'DD/MM/YYYY')              as min_date,\n       to_char(max(correction_requested_at), 'DD/MM/YYYY')              as max_date,\n       coalesce(correction_requested_by, 'All data wardens')            as dw_username,\n       count(CASE WHEN user_action = 'REQUEST_CORRECTION' THEN id END)  as sent_back,\n       count(CASE WHEN user_action = 'HOLD' THEN id END)                as held,\n       count(CASE WHEN user_action = 'RECALL' THEN id END)              as recalled,\n       count(CASE WHEN user_action = 'CLOSE' THEN id END)               as closed,\n       count(CASE WHEN user_action = 'MARK_DUPLICATE' THEN id END)      as marked_as_duplicate,\n       count(CASE WHEN user_action = 'MARK_NOT_REPORTABLE' THEN id END) as marked_as_np,\n       count(id)                                                        as total_actions\nfrom correction_request cr\nwhere user_type = 'DATA_WARDEN'\ngroup by day, ROLLUP(correction_requested_by)\n",
      "schema": {
        "field": [
          {
            "name": "day",
            "type": "date"
          },
          {
            "name": "min_date",
            "type": "date"
          },
          {
            "name": "max_date",
            "type": "date"
          },
          {
            "name": "dw_username",
            "type": "string"
          },
          {
            "name": "sent_back",
            "type": "long"
          },
          {
            "name": "held",
            "type": "long"
          },
          {
            "name": "recalled",
            "type": "long"
          },
          {
            "name": "closed",
            "type": "long"
          },
          {
            "name": "marked_as_duplicate",
            "type": "long"
          },
          {
            "name": "marked_as_np",
            "type": "long"
          },
          {
            "name": "total_actions",
            "type": "long"
          }
        ]
      }
    },
    {
      "id": "per-month",
      "name": "Actions performed / month",
      "datasource": "replicaDataSource",
      "query": "select Cast(Date_trunc('month', correction_requested_at) AS DATE)       as month,\n       to_char(min(correction_requested_at), 'DD/MM/YYYY')              as min_date,\n       to_char(max(correction_requested_at), 'DD/MM/YYYY')              as max_date,\n       coalesce(correction_requested_by, 'All data wardens') as dw_username,\n       count(CASE WHEN user_action = 'REQUEST_CORRECTION' THEN id END)  as sent_back,\n       count(CASE WHEN user_action = 'HOLD' THEN id END)                as held,\n       count(CASE WHEN user_action = 'RECALL' THEN id END)              as recalled,\n       count(CASE WHEN user_action = 'CLOSE' THEN id END)               as closed,\n       count(CASE WHEN user_action = 'MARK_DUPLICATE' THEN id END)      as marked_as_duplicate,\n       count(CASE WHEN user_action = 'MARK_NOT_REPORTABLE' THEN id END) as marked_as_np,\n       count(id)                                                        as total_actions\nfrom correction_request\nwhere user_type = 'DATA_WARDEN'\ngroup by month, ROLLUP(correction_requested_by)",
      "schema": {
        "field": [
          {
            "name": "month",
            "type": "date"
          },
          {
            "name": "min_date",
            "type": "date"
          },
          {
            "name": "max_date",
            "type": "date"
          },
          {
            "name": "dw_username",
            "type": "string"
          },
          {
            "name": "sent_back",
            "type": "long"
          },
          {
            "name": "held",
            "type": "long"
          },
          {
            "name": "recalled",
            "type": "long"
          },
          {
            "name": "closed",
            "type": "long"
          },
          {
            "name": "marked_as_duplicate",
            "type": "long"
          },
          {
            "name": "marked_as_np",
            "type": "long"
          },
          {
            "name": "total_actions",
            "type": "long"
          }
        ]
      }
    },
    {
      "id": "data_wardens",
      "name": "Data wardens",
      "datasource": "replicaDataSource",
      "query": "select DISTINCT(correction_requested_by) as dw_username\nfrom correction_request\nwhere user_type = 'DATA_WARDEN'\nUNION ALL\nselect 'All data wardens' as dw_username",
      "schema": {
        "field": [
          {
            "name": "dw_username",
            "type": "string"
          }
        ]
      }
    }
  ],
  "report": [
    {
      "id": "per-day",
      "name": "Actions performed / day",
      "description": "Count of incident report actions conducted by each data warden per day.",
      "version": "1.0.0",
      "dataset": "$ref:per-day",
      "policy": [],
      "render": "HTML",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:day",
            "display": "Day of incident",
            "formula": "format_date(${day}, 'dd-MMM-yyyy')",
            "sortable": true,
            "visible": "true",
            "defaultsort": true,
            "sortdirection": "desc",
            "filter": {
              "type": "daterange",
              "default": "today(-14,days) - today()"
            }
          },
          {
            "name": "$ref:dw_username",
            "display": "Data Warden",
            "sortable": true,
            "visible": "true",
            "defaultsort": false,
            "filter": {
              "type": "multiselect",
              "dynamicoptions": {
                "returnAsStaticOptions": true,
                "dataset": "data_wardens",
                "name": "dw_username",
                "display": "dw_username"
              }
            }
          },
          {
            "name": "$ref:sent_back",
            "display": "Sent back",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:held",
            "display": "Put on hold",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:recalled",
            "display": "Recalls",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:closed",
            "display": "Closed",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:marked_as_duplicate",
            "display": "Marked as <br/>duplicate",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:marked_as_np",
            "display": "Marked as <br/>not reportable",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:total_actions",
            "display": "Total number <br/>of actions",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          }
        ]
      },
      "destination": []
    },
    {
      "id": "per-month",
      "name": "Actions performed / month",
      "description": "Count of incident report actions conducted by each data warden per month.",
      "version": "1.0.0",
      "dataset": "$ref:per-month",
      "policy": [],
      "render": "HTML",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:month",
            "display": "Month <br/>of incident",
            "formula": "format_date(${month}, 'MMM-yyyy')",
            "sortable": true,
            "visible": "true",
            "defaultsort": true,
            "sortdirection": "desc",
            "filter": {
              "type": "daterange",
              "default": "today(-3,months) - today()"
            }
          },
          {
            "name": "$ref:dw_username",
            "display": "Data Warden",
            "sortable": true,
            "visible": "true",
            "defaultsort": false,
            "filter": {
              "type": "multiselect",
              "dynamicoptions": {
                "returnAsStaticOptions": true,
                "dataset": "data_wardens",
                "name": "dw_username",
                "display": "dw_username"
              }
            }
          },
          {
            "name": "$ref:sent_back",
            "display": "Sent back",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:held",
            "display": "Put on hold",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:recalled",
            "display": "Recalls",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:closed",
            "display": "Closed",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:marked_as_duplicate",
            "display": "Marked as <br/>duplicate",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:marked_as_np",
            "display": "Marked as <br/>not reportable",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:total_actions",
            "display": "Total number <br/>of actions",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          }
        ]
      },
      "destination": []
    }
  ]
}
