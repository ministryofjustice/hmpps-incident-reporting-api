{
  "id": "response-duration",
  "name": "Response duration statistics",
  "description": "Statistics focusing on time taken for reporting officers and data wardens to respond to report submissions.",
  "metadata": {
    "author": "Josh Jones",
    "version": "1.0.0",
    "owner": "Managing Safety"
  },
  "datasource": [
    {
      "id": "irs",
      "name": "replicaDataSource",
      "connection": "postgres"
    }
  ],
  "policy": [
    {
      "id": "access",
      "type": "access",
      "rule": [
        {
          "effect": "permit",
          "condition": [
            {
              "match": [
                "${role}",
                "INCIDENT_REPORTS__STATS"
              ]
            }
          ]
        }
      ]
    }
  ],
  "dataset": [
    {
      "id": "per-month",
      "name": "Response statistics per month",
      "datasource": "replicaDataSource",
      "query": "select dwlp.month, dw.min_date, dw.max_date, dwlp.location, dw_resp_time_days, ro_resp_time_days, feedback_loop_days\nfrom (\n\tselect Cast(Date_trunc('month', r.created_at) AS DATE) as month,\n\tCOALESCE(r.location, 'all active locations') as location, ROUND(AVG(stats.time_since_last)/24, 1) as feedback_loop_days\n\tfrom report as r\n\tleft join (\n\t\tselect cr.report_id, diff.time_since_last\n\t\tfrom correction_request as cr\n\t\t\tleft join (\t\n\t\tselect report_id, sequence, time_since_last from (\n\t\tselect *, sequence - lag(sequence) OVER (PARTITION by report_id order by sequence) as seq_diff, \n\t\t\tROUND(EXTRACT(epoch from (correction_requested_at - lag(correction_requested_at) OVER (PARTITION by report_id order by sequence) ))/3600, 1) as time_since_last\n\t\t\tfrom (\n\t\tselect cr.report_id, sequence, correction_requested_at\n\t\tfrom correction_request as cr\n\t\tleft join (\n\t\t\tselect report_id, CASE WHEN count(id) > 1 THEN 1 ElSE null END as marker\n\t\t\tfrom correction_request\n\t\t\twhere user_type = 'DATA_WARDEN'\n\t\t\tgroup by report_id) as mk\n\t\ton cr.report_id = mk.report_id\n\t\twhere mk.marker is not null and user_type = 'DATA_WARDEN'\n\t\torder by report_id, sequence\n\t\t\t)\n\t\t)\n\t\twhere seq_diff > 1\n\t\t\t) as diff\n\t\ton cr.report_id = diff.report_id and cr.sequence = diff.sequence\n\t\twhere diff.time_since_last is not null) as stats\n\ton r.id = stats.report_id\n\twhere r.source = 'DPS' and r.location not in ('NORTH', 'SOUTH')\n\tgroup by Date_trunc('month', r.created_at), ROLLUP(r.location)) as dwlp\njoin (\t\n\tselect Cast(Date_trunc('month', r.created_at) AS DATE) as month, COALESCE(r.location, 'all') as location, ROUND(AVG(stats.time_since_last)/24, 1) as ro_resp_time_days\n\tfrom report as r\n\tleft join (\n\t\tselect report_id, time_since_last\n\t\tfrom (\n\t\t\tselect *,\n\t\t\t\tROUND(EXTRACT(epoch from (correction_requested_at - lag(correction_requested_at) OVER (PARTITION by report_id order by sequence) ))/3600, 1) as time_since_last,\n\t\t\t\tlag(user_type) OVER (PARTITION by report_id order by sequence) as last_user_type\n\t\t\tfrom correction_request \n\t\t\torder by report_id desc, sequence\n\t\t)\n\t\twhere user_type <> last_user_type and user_type = 'REPORTING_OFFICER') as stats\n\ton r.id = stats.report_id\n\twhere r.source = 'DPS' and r.location not in ('NORTH', 'SOUTH')\n\tgroup by Date_trunc('month', r.created_at), ROLLUP(r.location)\n\t) as ro\n\ton dwlp.month = ro.month and dwlp.location = ro.location\njoin (\n\tselect Cast(Date_trunc('month', r.created_at) AS DATE) as month, to_char(min(r.created_at), 'DD/MM/YYYY') as min_date, to_char(max(r.created_at), 'DD/MM/YYYY') as max_date,\n\tCOALESCE(r.location, 'all') as location, ROUND(AVG(stats.time_since_last)/24, 1) as dw_resp_time_days\n\tfrom report as r\n\tleft join (\n\t\tselect report_id, time_since_last\n\t\tfrom (\n\t\t\tselect *,\n\t\t\t\tROUND(EXTRACT(epoch from (correction_requested_at - lag(correction_requested_at) OVER (PARTITION by report_id order by sequence) ))/3600, 1) as time_since_last,\n\t\t\t\tlag(user_type) OVER (PARTITION by report_id order by sequence) as last_user_type\n\t\t\tfrom correction_request \n\t\t\torder by report_id desc, sequence\n\t\t)\n\t\twhere user_type <> last_user_type and user_type = 'DATA_WARDEN') as stats\n\ton r.id = stats.report_id\n\twhere r.source = 'DPS' and r.location not in ('NORTH', 'SOUTH')\n\tgroup by Date_trunc('month', r.created_at), ROLLUP(r.location) ) as dw\non dwlp.month = dw.month and dwlp.location = dw.location",
      "schema": {
        "field": [
          {
            "name": "month",
            "type": "date"
          },
          {
            "name": "min_date",
            "type": "date"
          },
          {
            "name": "max_date",
            "type": "date"
          },
          {
            "name": "location",
            "type": "text"
          },
          {
            "name": "dw_resp_time_days",
            "type": "float"
          },
          {
            "name": "ro_resp_time_days",
            "type": "float"
          },
          {
            "name": "feedback_loop_days",
            "type": "float"
          }
        ]
      }
    }
  ],
  "report": [
    {
      "id": "per-month",
      "name": "Feedback durations / month",
      "description": "Average durations for reporting officers and data wardens to respond to report submissions.",
      "version": "1.0.0",
      "dataset": "$ref:per-month",
      "policy": [],
      "render": "HTML",
      "feature": [
        {
          "type": "print"
        }
      ],
      "specification": {
        "template": "list",
        "field": [
          {
            "name": "$ref:month",
            "display": "Month of incident",
            "formula": "format_date(${month}, 'MMM-yyyy')",
            "sortable": true,
            "visible": "true",
            "defaultsort": true,
            "sortdirection": "desc",
            "filter": {
              "type": "daterange",
              "default": "today(-3,months) - today()"
            }
          },
          {
            "name": "$ref:location",
            "display": "Location",
            "sortable": true,
            "visible": "true",
            "defaultsort": false,
            "filter": {
              "type": "caseloads",
              "mandatory": false
            }
          },
          {
            "name": "$ref:dw_resp_time_days",
            "display": "Average time for DW to respond to RO submission (days)",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:ro_resp_time_days",
            "display": "Average time for RO to respond to DW submission (days)",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          },
          {
            "name": "$ref:feedback_loop_days",
            "display": "Average time for another DW action after returning report to RO (days)",
            "sortable": true,
            "visible": "true",
            "defaultsort": false
          }
        ]
      },
      "destination": [],
      "summary": [{
        "id": "summaryId",
        "template": "page-header",
        "dataset": "$ref:per-month"
      }]
    }
  ]
}
